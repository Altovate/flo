var PayolaCheckout={initialize:function(){$(document).on("click",".payola-checkout-button",function(e){e.preventDefault(),PayolaCheckout.handleCheckoutButtonClick($(this))})},handleCheckoutButtonClick:function(e){var t=e.parent("form"),n=t.data(),i=StripeCheckout.configure({key:n.publishable_key,image:n.product_image_path,token:function(e){PayolaCheckout.tokenHandler(e,n)},name:n.name,description:n.description,amount:n.price,panelLabel:n.panel_label,allowRememberMe:n.allow_remember_me,zipCode:n.verify_zip_code,billingAddress:n.billing_address,shippingAddress:n.shipping_address,currency:n.currency,bitcoin:n.bitcoin,email:n.email||void 0});i.open()},tokenHandler:function(e,t){var n=$("#"+t.form_id);console.log(t.form_id),n.append($('<input type="hidden" name="stripeToken">').val(e.id)),n.append($('<input type="hidden" name="stripeEmail">').val(e.email)),t.signed_custom_fields&&n.append($('<input type="hidden" name="signed_custom_fields">').val(t.signed_custom_fields)),$(".payola-checkout-button").prop("disabled",!0),$(".payola-checkout-button-text").hide(),$(".payola-checkout-button-spinner").show(),$.ajax({type:"POST",url:t.base_path+"/buy/"+t.product_class+"/"+t.product_permalink,data:n.serialize(),success:function(e){PayolaCheckout.poll(e.guid,60,t)},error:function(e){PayolaCheckout.showError(e.responseJSON.error,t)}})},showError:function(e,t){var n=$("#"+t.error_div_id);n.html(e),n.show(),$(".payola-checkout-button").prop("disabled",!1),$(".payola-checkout-button-spinner").hide(),$(".payola-checkout-button-text").show()},poll:function(e,t,n){if(0===t)return void PayolaCheckout.showError("This seems to be taking too long. Please contact support and give them transaction ID: "+e,n);var i=function(i){"finished"===i.status?window.location=n.base_path+"/confirm/"+e:"errored"===i.status?PayolaCheckout.showError(i.error,n):setTimeout(function(){PayolaCheckout.poll(e,t-1,n)},500)};$.ajax({type:"GET",url:n.base_path+"/status/"+e,success:i,error:i})}};$(function(){PayolaCheckout.initialize()});var PayolaPaymentForm={initialize:function(){$(document).on("submit",".payola-payment-form",function(){return PayolaPaymentForm.handleSubmit($(this))})},handleSubmit:function(e){return e.find(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(t,n){PayolaPaymentForm.stripeResponseHandler(e,t,n)}),!1},stripeResponseHandler:function(e,t,n){if(n.error)PayolaPaymentForm.showError(e,n.error.message);else{var i=e.find("[data-payola='email']").val(),o=e.data("payola-base-path"),r=e.data("payola-product"),a=e.data("payola-permalink"),s=$("<form></form>");s.append($('<input type="hidden" name="stripeToken">').val(n.id)),s.append($('<input type="hidden" name="stripeEmail">').val(i)),s.append(PayolaPaymentForm.authenticityTokenInput()),$.ajax({type:"POST",url:o+"/buy/"+r+"/"+a,data:s.serialize(),success:function(t){PayolaPaymentForm.poll(e,60,t.guid,o)},error:function(t){PayolaPaymentForm.showError(e,t.responseJSON.error)}})}},poll:function(e,t,n,i){0===t&&PayolaPaymentForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+n),$.get(i+"/status/"+n,function(o){"finished"===o.status?(e.append($('<input type="hidden" name="payola_sale_guid"></input>').val(n)),e.append(PayolaPaymentForm.authenticityTokenInput()),e.get(0).submit()):"errored"===o.status?PayolaPaymentForm.showError(e,o.error):setTimeout(function(){PayolaPaymentForm.poll(e,t-1,n,i)},500)})},showError:function(e,t){$(".payola-spinner").hide(),e.find(":submit").prop("disabled",!1);var n=e.data("payola-error-selector");n?$(n).text(t):e.find(".payola-payment-error").text(t)},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};$(function(){PayolaPaymentForm.initialize()});var PayolaSubscriptionCheckout={initialize:function(){$(document).on("click",".payola-subscription-checkout-button",function(e){e.preventDefault(),PayolaSubscriptionCheckout.handleCheckoutButtonClick($(this))})},handleCheckoutButtonClick:function(e){var t=e.parent("form"),n=t.data(),i=StripeCheckout.configure({key:n.publishable_key,image:n.plan_image_path,token:function(e){PayolaSubscriptionCheckout.tokenHandler(e,n)},name:n.name,description:n.description,amount:n.price,panelLabel:n.panel_label,allowRememberMe:n.allow_remember_me,zipCode:n.verify_zip_code,billingAddress:n.billing_address,shippingAddress:n.shipping_address,currency:n.currency,email:n.email||void 0});i.open()},tokenHandler:function(e,t){var n=$("#"+t.form_id);console.log(t.form_id),n.append($('<input type="hidden" name="stripeToken">').val(e.id)),n.append($('<input type="hidden" name="stripeEmail">').val(e.email)),n.append($('<input type="hidden" name="quantity">').val(t.quantity)),t.signed_custom_fields&&n.append($('<input type="hidden" name="signed_custom_fields">').val(t.signed_custom_fields)),$(".payola-subscription-checkout-button").prop("disabled",!0),$(".payola-subscription-checkout-button-text").hide(),$(".payola-subscription-checkout-button-spinner").show(),$.ajax({type:"POST",url:n.attr("action"),data:n.serialize(),success:function(e){PayolaSubscriptionCheckout.poll(e.guid,60,t)},error:function(e){PayolaSubscriptionCheckout.showError(e.responseJSON.error,t)}})},showError:function(e,t){var n=$("#"+t.error_div_id);n.html(e),n.show(),$(".payola-subscription-checkout-button").prop("disabled",!1),$(".payola-subscription-checkout-button-spinner").hide(),$(".payola-subscription-checkout-button-text").show()},poll:function(e,t,n){if(0===t)return void PayolaSubscriptionCheckout.showError("This seems to be taking too long. Please contact support and give them transaction ID: "+e,n);var i=function(i){"active"===i.status?window.location=n.base_path+"/confirm_subscription/"+e:"errored"===i.status?PayolaSubscriptionCheckout.showError(i.error,n):setTimeout(function(){PayolaSubscriptionCheckout.poll(e,t-1,n)},500)};$.ajax({type:"GET",url:n.base_path+"/subscription_status/"+e,success:i,error:i})}};$(function(){PayolaSubscriptionCheckout.initialize()});var PayolaOnestepSubscriptionForm={initialize:function(){$(document).on("submit",".payola-onestep-subscription-form",function(){return PayolaOnestepSubscriptionForm.handleSubmit($(this))})},handleSubmit:function(e){return $(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(t,n){PayolaOnestepSubscriptionForm.stripeResponseHandler(e,t,n)}),!1},stripeResponseHandler:function(e,t,n){if(n.error)PayolaOnestepSubscriptionForm.showError(e,n.error.message);else{var i=e.find("[data-payola='email']").val(),o=e.find("[data-payola='coupon']").val(),r=e.find("[data-payola='quantity']").val(),a=e.data("payola-base-path"),s=e.data("payola-plan-type"),l=e.data("payola-plan-id"),u=$(e).attr("action");e.append($('<input type="hidden" name="plan_type">').val(s)),e.append($('<input type="hidden" name="plan_id">').val(l)),e.append($('<input type="hidden" name="stripeToken">').val(n.id)),e.append($('<input type="hidden" name="stripeEmail">').val(i)),e.append($('<input type="hidden" name="coupon">').val(o)),e.append($('<input type="hidden" name="quantity">').val(r)),e.append(PayolaOnestepSubscriptionForm.authenticityTokenInput()),$.ajax({type:"POST",url:u,data:e.serialize(),success:function(t){PayolaOnestepSubscriptionForm.poll(e,60,t.guid,a)},error:function(t){PayolaOnestepSubscriptionForm.showError(e,t.responseJSON.error)}})}},poll:function(e,t,n,i){0===t&&PayolaOnestepSubscriptionForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+n);var o=function(o){"active"===o.status?window.location=i+"/confirm_subscription/"+n:setTimeout(function(){PayolaOnestepSubscriptionForm.poll(e,t-1,n,i)},500)},r=function(t){PayolaOnestepSubscriptionForm.showError(e,t.responseJSON.error)};$.ajax({type:"GET",dataType:"json",url:i+"/subscription_status/"+n,success:o,error:r})},showError:function(e,t){$(".payola-spinner").hide(),$(":submit").prop("disabled",!1);var n=e.data("payola-error-selector");n?($(n).text(t),$(n).show()):(e.find(".payola-payment-error").text(t),e.find(".payola-payment-error").show())},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};$(function(){PayolaOnestepSubscriptionForm.initialize()});var PayolaSubscriptionForm={initialize:function(){$(document).on("submit",".payola-subscription-form",function(){return PayolaSubscriptionForm.handleSubmit($(this))})},handleSubmit:function(e){return $(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(t,n){PayolaSubscriptionForm.stripeResponseHandler(e,t,n)}),!1},stripeResponseHandler:function(e,t,n){if(n.error)PayolaSubscriptionForm.showError(e,n.error.message);else{var i=e.find("[data-payola='email']").val(),o=e.find("[data-payola='coupon']").val(),r=e.find("[data-payola='quantity']").val(),a=e.data("payola-base-path"),s=e.data("payola-plan-type"),l=e.data("payola-plan-id"),u=$("<form></form>");u.append($('<input type="hidden" name="stripeToken">').val(n.id)),u.append($('<input type="hidden" name="stripeEmail">').val(i)),u.append($('<input type="hidden" name="coupon">').val(o)),u.append($('<input type="hidden" name="quantity">').val(r)),u.append(PayolaSubscriptionForm.authenticityTokenInput()),$.ajax({type:"POST",url:a+"/subscribe/"+s+"/"+l,data:u.serialize(),success:function(t){PayolaSubscriptionForm.poll(e,60,t.guid,a)},error:function(t){PayolaSubscriptionForm.showError(e,t.responseJSON.error)}})}},poll:function(e,t,n,i){0===t&&PayolaSubscriptionForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+n);var o=function(o){"active"===o.status?(e.append($('<input type="hidden" name="payola_subscription_guid"></input>').val(n)),e.append(PayolaSubscriptionForm.authenticityTokenInput()),e.get(0).submit()):setTimeout(function(){PayolaSubscriptionForm.poll(e,t-1,n,i)},500)},r=function(t){"errored"===t.responseJSON.status&&PayolaSubscriptionForm.showError(e,t.responseJSON.error)};$.ajax({type:"GET",dataType:"json",url:i+"/subscription_status/"+n,success:o,error:r})},showError:function(e,t){$(".payola-spinner").hide(),$(":submit").prop("disabled",!1);var n=e.data("payola-error-selector");n?($(n).text(t),$(n).show()):(e.find(".payola-payment-error").text(t),e.find(".payola-payment-error").show())},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};$(function(){PayolaSubscriptionForm.initialize()});